<<<<<<< HEAD
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("express")),t=e(require("jsonata")),n=e(require("cors"));const i=require("fs"),o=require("path"),s=require("smarkt"),u=require("yaml"),c=require("json5"),a=require("gray-matter");function l(e){if(e.match(/\.([0-9a-z]+)(?:[?#]|$)/i))return e.match(/\.([0-9a-z]+)(?:[?#]|$)/i)[1]}function f(e,r){return function(e,r){if("json"===l(r)){let t=i.readFileSync(o.join(e,r),"utf8");return JSON.parse(t)}}(e,r)||function(e,r){if("md"===l(r)){var t=i.readFileSync(o.join(e,r),"utf8");const{data:n,content:s}=a(t);return{...n,content:s}}}(e,r)||function(e,r){if("txt"===l(r)){return s.parse(i.readFileSync(o.join(e,r),"utf8"))}}(e,r)||function(e,r){if("yml"===l(r)||"yaml"===l(r)){return u.parse(i.readFileSync(o.join(e,r),"utf8"))}}(e,r)||function(e,r){if("json5"===l(r)){let t=i.readFileSync(o.join(e,r),"utf8");return c.parse(t)}}(e,r)}const d=require("fs"),p=require("path"),h=require("pluralize"),y={is:{file:function(e){return!!/\..+$/.test(e)&&e.split(".")[0]},folder:function(e){return!/\..+$/.test(e)&&e},singular:function(e){return h.isSingular(e)},plural:function(e){return h.isPlural(e)},index:function(e){return/^index..+$/.test(e)},collection:function(e,r){let t=!1;return y.is.folder(r)&&(t=!0),t},item:function(e,r){let t=!1;return(y.is.file(r)||y.has.index(e,r))&&(t=!0),t},hidden:function(e){return/^_/.test(e)}},has:{index:function(e,r){let t=!1;return y.is.folder(r)&&d.readdirSync(p.join(e+r)).map(e=>{y.is.index(e)&&(t=!0)}),t},children:function(e,r){let t=!1;return y.is.folder(r)&&d.readdirSync(p.join(e+r)).map(()=>{t=!0}),t}}};function m(e){let r=e;return d.readdirSync(e).map((t,n)=>function e(r,t,n,i,o){if(y.is.hidden(t))return;let s={_index:n,_name:t.split(".")[0]},u=t.split(".")[0];"home"===t&&(u="");let c=r.replace(o.replace(p.sep,""),"");if(s.url=p.join(c+u),s._source=p.join(r+u),y.is.singular(t),y.is.folder(t)&&y.has.index(r,t),y.is.item(r,t)&&(s._collection=i,s._type=i||t.split(".")[0]),y.is.folder(t)){let n=p.join(r+t+"/"),i=t;d.readdirSync(n).map((r,t)=>{e(n,r,t,i,o)})}if(y.is.file(t)&&Object.assign(s,f(r,t)),y.is.folder(t)&&!y.is.item(r,t)){let e="";d.readdirSync(r).map(t=>{/index..+$/.test(t)&&(e=f(r,t))}),Object.assign(s,e)}if(y.is.folder(t)){let n=p.join(r+t+"/"),i=t;s[i]=[],d.readdirSync(p.join(r+t)).map((r,t)=>{y.is.index(r)||s[i].push(e(n,r,t,i,o))})}return s}(e,t,n,null,r))}function g(e){return m(e)}async function j(e,{resource1:r,resource2:n,query:i}){var o,s=t(`**[_type="${r}"]`);if(r&&!n){if(i){let e=[];for(let[r,t]of Object.entries(i)){let n=`[${r}=${t}]`;e.push(n)}s=t(`**[_type="${r}"]${e.toString()}`)}return s.evaluate(e)}if(r&&n){if(i){let e=[];for(let[r,t]of Object.entries(i)){let n=`[${r}=${t}]`;e.push(n)}s=t(`**[_type="${r}"][_name="${n}"]${e.toString()}`)}return s.evaluate(e)}if((!r||!n)&&i){if(o=i,0===Object.keys(o).length&&o.constructor===Object)return e;let r=[];for(let[e,t]of Object.entries(i)){let n=`[${e}=${t}]`;r.push(n)}return(s=t("**"+r.toString())).evaluate(e)}}const q=require("chokidar"),$=require("http"),S=q.watch("content/",{ignored:/(^|[/\\])\../,persistent:!0});function v(e,t,i){t=t||3e3,i||(i="/");var o,s="";function u(){var u;(s=$.createServer((u=r(),o=g(e),u.use(n({origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:!1,optionsSuccessStatus:204})),u.set("json spaces",4),u.get(i,(e,r)=>{j(o,{resource1:null,resource2:null,query:e.query}).then(t=>{t?(r.json(t),console.log("0")):r.send("No value that matches query \n "+e.url)})}),u.get(i+":resource1",(e,r)=>{j(o,{resource1:e.params.resource1,resource2:null,query:e.query}).then(t=>{t?(r.json(t),console.log("1")):r.send("No value that matches query \n "+e.url)})}),u.get(i+":resource1/:resource2",(e,r)=>{j(o,{resource1:e.params.resource1,resource2:e.params.resource2,query:e.query}).then(t=>{t?r.json(t):r.send("No value that matches query \n "+e.url)})}),u))).listen(t,()=>{console.log(`Server listening at http://localhost:${t}${i}`),console.log("test")})}u(),S.on("change",()=>{console.log("restart"),s.close(),console.log("start"),u()})}function _(e,r,t){return function({base:e,method:r,path:t,data:n,token:i}){const o=process.browser?window.fetch:require("node-fetch").default,s={method:r,headers:{}};return n&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(n)),i&&(s.headers.Authorization="Token "+i),o(`${e}/${t}`,s).then(e=>e.text()).then(r=>{try{return JSON.parse(r)}catch(n){return console.log(`${e}/${t}`),r}})}({method:"GET",path:r,token:t,base:e})}var b=new class{constructor(){this._config={}}_process(e,r){return e=JSON.parse(e),r.process?(Array.isArray(e)?e.map(e=>{e&&(e=r.process({item:e}))}):e&&(e=r.process({item:e})),e):e}config(e){this._config=e}fetch(e){var r=this._config;const t=process.browser?window.fetch:require("node-fetch").default;var n=r.preview||"http://localhost:3000/api/";return"development"===process.env.NODE_ENV?(r.preview&&(n=r.preview),n=r.production):n=r.production,t(`${n}${e}`).then(e=>e.text()).then(e=>{try{return this._process(e,r)}catch(r){return e}})}};(module.exports=function(e){return{serve:function(r,t){return v(e,r,t)},get:function(e,r){return _(e,r)},database:function(){return g(e)}}}).client=b;
=======
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("http")),t=e(require("express")),s=e(require("cors")),n=e(require("smarkt")),o=e(require("yaml")),i=e(require("json5")),c=e(require("node-fetch")),u=e(require("chokidar"));const a=process.browser?void 0:require("fs"),l=process.browser?void 0:require("path"),p=require("front-matter");function f(e){if(e.match(/\.([0-9a-z]+)(?:[?#]|$)/i))return e.match(/\.([0-9a-z]+)(?:[?#]|$)/i)[1]}function d(e,r){return function(e,r){if(!process.browser&&"json"===f(r)){let t=a.readFileSync(l.join(e,r),"utf8");return JSON.parse(t)}}(e,r)||function(e,r){if(!process.browser&&"md"===f(r)){var t=a.readFileSync(l.join(e,r),"utf8");const{attributes:s,body:n}=p(t);return{...s,content:n}}}(e,r)||function(e,r){if(!process.browser&&"txt"===f(r)){return n.parse(a.readFileSync(l.join(e,r),"utf8"))}}(e,r)||function(e,r){if(!process.browser&&("yml"===f(r)||"yaml"===f(r))){return o.parse(a.readFileSync(l.join(e,r),"utf8"))}}(e,r)||function(e,r){if(!process.browser&&"json5"===f(r)){let t=a.readFileSync(l.join(e,r),"utf8");return i.parse(t)}}(e,r)}const h=require("fs"),y=require("path"),m=require("pluralize"),j={is:{file:function(e){return!!/\..+$/.test(e)&&e.split(".")[0]},folder:function(e){return!/\..+$/.test(e)&&e},singular:function(e){return m.isSingular(e)},plural:function(e){return m.isPlural(e)},index:function(e){return/^index..+$/.test(e)},collection:function(e,r){let t=!1;return j.is.folder(r)&&(t=!0),t},item:function(e,r){let t=!1;return(j.is.file(r)||j.has.index(e,r))&&(t=!0),t},hidden:function(e){return/^_/.test(e)}},has:{index:function(e,r){let t=!1;return j.is.folder(r)&&h.readdirSync(y.join(e+r)).map(e=>{j.is.index(e)&&(t=!0)}),t},children:function(e,r){let t=!1;return j.is.folder(r)&&h.readdirSync(y.join(e+r)).map(()=>{t=!0}),t}}};function _(e){let r=e;return h.readdirSync(e).map((t,s)=>function e(r,t,s,n,o){if(j.is.hidden(t))return;let i={_index:s,_name:t.split(".")[0]},c=t.split(".")[0];"home"===t&&(c="");let u=r.replace(o.replace(y.sep,""),"");if(i.url=y.join(u+c),i._source=y.join(r+c),j.is.singular(t),j.is.folder(t)&&j.has.index(r,t),j.is.item(r,t)&&(i._collection=n,i._type=n||t.split(".")[0]),j.is.folder(t)){let s=y.join(r+t+"/"),n=t;h.readdirSync(s).map((r,t)=>{e(s,r,t,n,o)})}if(j.is.file(t)&&Object.assign(i,d(r,t)),j.is.folder(t)&&!j.is.item(r,t)){let e="";h.readdirSync(r).map(t=>{/index..+$/.test(t)&&(e=d(r,t))}),Object.assign(i,e)}if(j.is.folder(t)){let s=y.join(r+t+"/"),n=t;i[n]=[],h.readdirSync(y.join(r+t)).map((r,t)=>{j.is.index(r)||i[n].push(e(s,r,t,n,o))})}return i}(e,t,s,null,r))}const v=require("jsonata");async function S(e,{resource1:r,resource2:t,query:s}){var n,o=v(`**[_type="${r}"]`);if(r&&!t){if(s){let e=[];for(let[r,t]of Object.entries(s)){let s=`[${r}=${t}]`;e.push(s)}o=v(`**[_type="${r}"]${e.toString()}`)}return o.evaluate(e)}if(r&&t){if(s){let e=[];for(let[r,t]of Object.entries(s)){let s=`[${r}=${t}]`;e.push(s)}o=v(`**[_type="${r}"][_name="${t}"]${e.toString()}`)}return o.evaluate(e)}if((!r||!t)&&s){if(n=s,0===Object.keys(n).length&&n.constructor===Object)return e;let r=[];for(let[e,t]of Object.entries(s)){let s=`[${e}=${t}]`;r.push(s)}return(o=v("**"+r.toString())).evaluate(e)}}class b{constructor(e,r,t){t&&(this._source=t),this._options={production:e},r&&Object.assign(this._options,{preview:r})}_process(e,r){return e=JSON.parse(e),r.preprocess?("content"===r.preprocess[0]&&(Array.isArray(e)?e.map(e=>{e.content&&(e.content=r.preprocess[1](e.content))}):e.content&&(e.content=r.preprocess[1](e.content))),"item"===r.preprocess[0]&&(Array.isArray(e)?e.map(e=>r.preprocess[1](e)):e=r.preprocess[1](e)),"collection"===r.preprocess[0]&&Array.isArray(e)&&(e=r.preprocess[1](e)),e):e}get(e){var r=this._options;return(process.browser?window.fetch:c)(`${"development"===process.env.NODE_ENV&&r.preview&&"undefined"!==this._source&&!process.browser?r.preview:r.production}${e}`).then(e=>e.text()).then(e=>{try{return this._process(e,r)}catch(r){return e}})}preprocess(e,r){Object.assign(this._options,{preprocess:[e,r]})}}module.exports=function(e){return new class{constructor(e){"undefined"!==e&&(this._source=e)}server(e,n){if(!this._source)return console.log("[Stancy] No source provided");e=e||4e3,n=n||"/",this._local=`http://localhost:${e}${n}`;var o,i,c=this._source;function a(){(o=r.createServer(function(e){var r=t();return i=_(c),r.use(s({origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:!1,optionsSuccessStatus:204})),r.set("json spaces",4),r.get(e,(e,r)=>{S(i,{resource1:null,resource2:null,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r.get(e+":resource1",(e,r)=>{S(i,{resource1:e.params.resource1,resource2:null,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r.get(e+":resource1/:resource2",(e,r)=>{S(i,{resource1:e.params.resource1,resource2:e.params.resource2,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r}(n))).listen(e,()=>{console.log(`[Stancy] Content server available at http://localhost:${e}${n}`)})}a(),process.browser||u.watch(c,{ignored:/(^|[/\\])\../,persistent:!0}).on("change",()=>{o.close(),console.log("API server restarting"),a()})}client(e){return this._local||process.browser||this.server(),new b(e,this._local,this._source)}database(){return _(this._source)}}(e)};
>>>>>>> refactored
