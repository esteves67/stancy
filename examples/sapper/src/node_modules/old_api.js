import marked from 'marked';

var options = {
	local: null,
	remote: null,
	preprocess: null
};

function processContent(data, callback) {
	if (callback !== null) {
		if (Array.isArray(data)) {
			data.map((item) => {
				item.content = callback(item.content);
			});
		} else {
			data.content = callback(data.content);
		}
		return data;
	} else {
		return data;
	}
}

export function send({ method, path, data, token }) {
	const fetch = process.browser ? window.fetch : require('node-fetch').default;

	const opts = { method, headers: {} };

	if (data) {
		opts.headers['Content-Type'] = 'application/json';
		opts.body = JSON.stringify(data);
	}

	if (token) {
		opts.headers['Authorization'] = `Token ${token}`;
	}

	var base = '';
	if (process.env.NODE_ENV === 'development') {
		base = options.local;
	} else {
		base = options.remote;
	}

	return fetch(`${base}${path}`, opts).then((r) => r.text()).then((json) => {
		var data = JSON.parse(json);
		try {
			return processContent(data, options.preprocess);
		} catch (err) {
			return json;
		}
	});
}

export function client({ preprocess, local, remote }) {
	options.preprocess = null || preprocess;
	options.local = null || local;
	options.remote = null || remote;
	return {
		get: (path, token) => {
			return get(path, token);
		}
	};
}

export default function stancy() {
	return {
		fetch: (path, token) => {
			return send({ method: 'GET', path, token });
		},
		client: ({ preprocess, local, remote }) => {
			return client({ preprocess, local, remote });
		}
	};
}

client({
	local: 'http://localhost:4000/api/',
	remote: 'https://now-restlike-api.now.sh/api/',
	preprocess: (content) => marked(content)
});
