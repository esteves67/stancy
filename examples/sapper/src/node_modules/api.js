import marked from 'marked';

class Client {
	constructor() {
		this._config = {};
	}
	_process(data, callback) {
		data = JSON.parse(data);
		if (callback !== null) {
			if (Array.isArray(data)) {
				data.map((item) => {
					if (item.content) {
						item.content = callback(item.content);
					}
				});
			} else {
				if (data.content) {
					data.content = callback(data.content);
				}
			}
			return data;
		} else {
			return data;
		}
	}
	config(value) {
		this._config = value;
	}
	fetch(path) {
		var config = this._config;

		const fetch = process.browser ? window.fetch : require('node-fetch').default;

		var base = config.local || 'http://localhost:3000/api/';

		if (process.env.NODE_ENV === 'development') {
			base = config.local;
		} else {
			base = config.remote;
		}

		return fetch(`${base}${path}`).then((r) => r.text()).then((json) => {
			try {
				var result = this._process(json, config.preprocess);
				return result;
			} catch (err) {
				return json;
			}
		});
	}
}

var stancy = new Client();

stancy.config({
	local: 'http://localhost:4000/api/',
	remote: 'https://now-restlike-api.now.sh/api/',
	preprocess: (content) => {
		return marked(content);
	}
});

export default stancy;
